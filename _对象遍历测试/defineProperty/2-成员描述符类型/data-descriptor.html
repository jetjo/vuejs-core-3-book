<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data descriptor</title>
  </head>
  <body>
    <pre>
        学习data descriptor;
        property descriptor共有两种类型,
        其中一种是data descriptor,
        另一种是accessor descriptor.
        configurable、enumerable是两种descriptor类型共有的配置项;
        value、writable是data descriptor独有的配置项.
        set、get是accessor descriptor独有的配置项.
        <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty'>
            If a descriptor doesn't have any of the value, writable, get, and set keys,
            it is treated as a data descriptor.
            If a descriptor has both [value or writable] and [get or set] keys,
            an exception is thrown.
        </a>
        1、测试通过defineProperty调用的方式定义成员时,
        descriptor.writable配置项的作用,
        和descriptor.configurable配置项对writable配置项的影响.
        2、只要configurable和writable有一个为truth, 
        就可以通过再次调用defineProperty的方法重新设置descriptor.value.
        3、但是通过obj[propertyName]=propertyValue的方式能否设置descriptor.value,
        只取决于descriptor.writable.
        <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty'>
            <!-- <pre> -->
                4、当descriptor.configurable为false时,
                    a、不能改变property descriptor的类型;
                    b、不能删除属性;
                    c、不能改变descriptor的配置;
                        但是对于data descriptor的类型,
                        如果writable为true,
                        可以重新设置writable为false.
                        一旦writable设置为false,在configurable也为false的情况下,writable不能改回true.
            <!-- </pre> -->
        </a>
    </pre>
    <!-- 使用赋值方式使用data descriptor -->
    <script type="module">
      // <script> // 默认类型的script标签,其顶部的const、let变量仍是全局的
      // property descriptor共有两种类型,
      // 其中一种是data descriptor,
      // property descriptor不能是两种类型的混合
      /* 这种方式定义的property, 
      其descriptor的writable、enumerable、configurable默认值都是true */
      const obj = { name: 'liuyifei' }
      obj.price = 3000
      const descriptors = Object.getOwnPropertyDescriptors(obj)
      console.log('使用赋值方式定义的data descriptors: ', descriptors)
    </script>
    <script>
      // 'use strict;'
      'use strict' // 防止一些本该抛出的异常无法抛出
      const descriptor = {}
      function resetDescriptor() {
        descriptor.__proto__ = null
        for (const key in descriptor) {
          delete descriptor[key]
        }
        descriptor.value = 3000
        descriptor.writable = false
        /* 以下是两种property descriptor共享的配置项 */
        descriptor.configurable = false
        // descriptor.enumerable = false
      }
      resetDescriptor()
      // assign [value] to property [propertyName] of [obj]
      function reSetObjPropertyValue(obj, propertyName, value, testTag) {
        try {
          // 当属性只读时,如果运行在非严格模式下,不会抛出异常,但仍然是赋值失败的
          obj[propertyName] = value
        } catch (err) {
          console.warn(testTag, err.message)
        }
      }
      function deleteObjProperty(obj, propertyName, testTag) {
        try {
          // 当属性只读时,如果运行在非严格模式下,不会抛出异常,但仍然是赋值失败的
          delete obj[propertyName]
        } catch (err) {
          console.warn(testTag, err.message)
        }
      }
      //  redefine [obj] property: [propertyName]
      function reDefineProperty(obj, propertyName, testTag) {
        try {
          Object.defineProperty(obj, propertyName, descriptor)
        } catch (err) {
          console.warn(testTag, err.message)
        }
      }
    </script>
    <!-- 使用defineProperty调用的方式使用data descriptor -->
    <script type="module">
      resetDescriptor()
      const testTag1 = '测试1、不可写、不可配置的默认情况: '
      const obj = {}
      Object.defineProperty(obj, 'price', descriptor)
      console.log(
        '========Start: ',
        testTag1,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )

      // TypeError: Cannot assign to read only property 'price' of object '#<Object>'
      reSetObjPropertyValue(obj, 'price', 1000, testTag1)

      console.log(testTag1, '改变value为1001: ')
      descriptor.value = 1001
      // TypeError: Cannot redefine property: price
      reDefineProperty(obj, 'price', testTag1)

      console.log(testTag1, '设置为可配置: ')
      descriptor.configurable = true
      //   descriptor.writable = true
      // TypeError: Cannot redefine property: price
      reDefineProperty(obj, 'price', testTag1)

      console.log(
        '========End: ',
        testTag1,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )
    </script>
    <script type="module">
      resetDescriptor()
      descriptor.configurable = true
      const testTag2 = '测试2、不可写、可配置的情况: '
      const obj = {}
      Object.defineProperty(obj, 'price', descriptor)
      console.log(
        '========Start: ',
        testTag2,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )

      // TypeError: Cannot assign to read only property 'price' of object '#<Object>'
      reSetObjPropertyValue(obj, 'price', 1000, testTag2)

      console.log(testTag2, '改变value为1001: ')
      descriptor.value = 1001
      reDefineProperty(obj, 'price', testTag2)
      console.log(Object.getOwnPropertyDescriptor(obj, 'price'))

      console.log(testTag2, '设置为可写: ')
      descriptor.writable = true
      reDefineProperty(obj, 'price', testTag2)
      console.log(Object.getOwnPropertyDescriptor(obj, 'price'))

      reSetObjPropertyValue(obj, 'price', 666, testTag2)

      console.log(
        '========End: ',
        testTag2,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )
    </script>
    <script type="module">
      resetDescriptor()
      descriptor.writable = true
      const testTag3 = '测试3、可写、不可配置的情况: '
      const obj = {}
      Object.defineProperty(obj, 'price', descriptor)
      console.log(
        '========Start: ',
        testTag3,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )

      reSetObjPropertyValue(obj, 'price', 1000, testTag3)
      console.log(Object.getOwnPropertyDescriptor(obj, 'price'))

      console.log(testTag3, '改变value为1001: ')
      descriptor.value = 1001
      reDefineProperty(obj, 'price', testTag3)
      console.log(Object.getOwnPropertyDescriptor(obj, 'price'))

      console.log(testTag3, '设置为可配置: ')
      descriptor.configurable = true
      // TypeError: Cannot redefine property: price
      reDefineProperty(obj, 'price', testTag3)

      resetDescriptor()
      descriptor.writable = true

      console.log(testTag3, '设置为不可写: ')
      descriptor.writable = false
      reDefineProperty(obj, 'price', testTag3)
      console.log(Object.getOwnPropertyDescriptor(obj, 'price'))

      console.log(testTag3, '删除price属性: ')
      deleteObjProperty(obj, 'price', testTag3)

      console.log(
        '========End: ',
        testTag3,
        Object.getOwnPropertyDescriptor(obj, 'price')
      )
    </script>
    <p><a href="./accessor-descriptor.html">accessor-descriptor</a></p>
  </body>
</html>
